.. _export-hazard-results:

Exporting results from a hazard calculation
===========================================

There are two alternative ways to get results from the OpenQuake-engine: directly through the calculation or by 
exporting them from the internal OpenQuake engine database once a calculation is completed.

The first option is defined at the OpenQuake-engine invocation through the flag ``–exports xml``, as shown in the example 
below::

	user@ubuntu:~$ oq engine --run job.ini --exports xml

This will export the results to the ``results`` directory specified in the ``job.ini`` file.

The second option allows the user to export the computed results or just a subset of them whenever they want. In order 
to obtain the list of results of the hazard calculations stored in the OpenQuake engine database the user can utilize 
the ``--lhc`` command (‘list hazard calculations’) to list the hazard calculations::

	user@ubuntu:~$ oq engine --lhc

The execution of this command will produce a list similar to the one provided below (the numbers in red are the 
calculations IDs)::

	user@ubuntu:~$ oq engine --lhc
	job_id | status | start_time | description
	1 | failed | 2013-03-01 09:49:34 | Classical PSHA
	2 | successful | 2013-03-01 09:49:56 | Classical PSHA
	3 | failed | 2013-03-01 10:24:04 | Classical PSHA
	4 | failed | 2013-03-01 10:28:16 | Classical PSHA
	5 | failed | 2013-03-01 10:30:04 | Classical PSHA
	6 | successful | 2013-03-01 10:31:53 | Classical PSHA
	7 | failed | 2013-03-09 08:15:14 | Classical PSHA
	8 | successful | 2013-03-09 08:18:04 | Classical PSHA

Subsequently the user can get the list of result stored for a specific hazard analysis by using the ``--list-outputs``, 
or ``--lo``, command, as in the example below (note that the number in blue emphasizes the result ID)::

	user@ubuntu:~$ oq engine --lo <calc_id>
	id | name
	3 | hcurves

and finally extract an xml file for a specific hazard result::

	user@ubuntu:~$ oq engine --export-outputs <result_id> <output_folder>

Description of hazard outputs
-----------------------------

The results generated by the OpenQuake-engine are fundamentally of two distinct typologies differentiated by the 
presence (or absence) of epistemic uncertainty in the PSHA input model.

When epistemic uncertainty is incorporated into the calculation, the OpenQuake-engine calculators (e.g. Classical PSHA, 
Event Based PSHA, Disaggregation, UHS) produce a set of results (i.e. hazard curves, ground motion fields, 
disaggregation outputs, UHS, for each logic-tree realisation) which reflects epistemic uncertainties introduced in the 
PSHA input model. For each logic tree sample, results are computed and stored. Calculation of results statistics (mean, 
standard deviation, quantiles) are supported by all the calculators.

By default, OpenQuake will export only the statistical results, i.e. mean curves and quantiles. If the user requires 
the complete results for all realizations, there is a flag to specify, please see the `FAQ <https://github.com/gem/oq-engine/blob/master/doc/faq-hazard.md>`_. 
Beware that if the logic tree contains a large number of end branches the process of exporting the results from each end 
Branch can add a significant amount of time - possibly longer than the computation time - and result in a large volume 
of disk spaced being used. In this case it is best to postprocess the data programmatically. Please contact us and we 
will be happy to give directions on how to do that in Python.

NB: in the literature there are different algorithms for the computation of the quantiles. The OpenQuake engine uses an 
algorithm based on interpolation which is implemented here:

`gem/oq-engine <https://github.com/gem/oq-engine/tree/master/openquake/hazardlib/stats.py>`_

In particular, the median is computed as the q=0.5 quantile.